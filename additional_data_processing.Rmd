---
title: "additional_data_processing"
output: html_document
date: "2023-06-06"
---
Since the accessibility and travel time metrics return empty outcomes. A couple of sources of error are being investigated. 
- After comparing the r5r_core file with the sample document, nothing looks abnormal. Plotted the network of london and it seems fine. (in the predict_access_time.RMD file)
- The example use GTFS file which nevertheless is optional, while this attempt did not. So tried using GTFS. 
- Another optional file is elevation. Also tried extracting elevation. 
- Some different methods of sourcing OSM pbf file attempted. 

Although none of the above resolves the issue, they bring additional / optional information that is useful for the prediction. Plus, they are all reproducible! 

This document is the reproducible process of generating input data for r5r. Files generated include - 
1. GTFS zip 
2. elevation tif 
3. other methods accessing OSM pbf

```{r}
library(sf)
library(data.table)
library(ggplot2)
library(interp)
library(dplyr)
library(tidytransit)
library(elevatr)
library(raster)
library(rgdal)
library(osmextract)
```

## GTFS 

London GTFS downloaded from: https://www.transit.land/feeds/f-dpwh-londontransit
Download date: June 5, 2023

Still not working. 

Then another gtfs source is used. It is in the format of TransXchange data, downloaded from the website: https://www.travelinedata.org.uk/traveline-open-data/traveline-national-dataset/. This website requires the open source software like Filezilla or Core FTP to download the remote TransXchange data zip files to the local directory. 

Then the TransXchange data will be converted to gtfs format using UK2GTFS r package. 

```{r}
#install.packages("remotes")
remotes::install_github("ITSleeds/UK2GTFS")
```

```{r}
library(UK2GTFS)
library(tidyverse)
```


```{r}
path_in <- "input/L.zip"
gtfs <- transxchange2gtfs(path_in = path_in,
 ncores = 3)
```
Save the converted version of gtfs. 

```{r}
gtfs_write(gtfs, folder = "C:/Users/99/Documents/CASA/Dissertation_data/input", name = "London_GTFS")
```

## Elevation 

Then adding elevation using elevatr R package (June 5). 

```{r}
ldn <-  read_sf("data/London_Boroughs.gpkg")%>%
    st_transform(., 4326)
```

```{r}
elevation <- get_elev_raster(ldn, z = 10)
```

```{r}
if (require(rgdal)) {
 rf <- writeRaster(elevation, filename=file.path("data/london_elev.tif"), format="GTiff", overwrite=TRUE)
}
```

```{r}
elevation
```

```{r}
ldn_sp <- as(ldn, "Spatial")
```

```{r}
plot(elevation, main="This the downloaded DEM [meters]")
plot(ldn_sp,col="NA",border="black", add=TRUE)
text(coordinates(ldn_sp), 
     col="black", cex=0.20)
```
```{r}
elev_crop = crop(elevation, ldn_sp)
plot(elev_crop, main="Cropped digital elevation model")
plot(ldn_sp, add=TRUE)
text(coordinates(ldn_sp), cex=0.2)
```

```{r}
crs(elev_crop)
```
```{r}
writeRaster(elev_crop, filename="r5rdata/london_elevation.tif", datatype='INT4S', overwrite=TRUE)
```

After reading in all the optional files, the output is still void. 
But the error message goes: 
ERROR c.c.r.t.TransportNetwork - TransportNetwork transit layer is loaded but timezone is unknown; API request times will be interpreted as GMT.

## OSM

it is then decided to try a different pbf source for OSM data (from geofabrik website to osmextract R package)
Note: osmdata is good for smaller case area while osmextract can cope with larger data size. 

```{r}
osm_lines = oe_get("London", stringsAsFactors = FALSE, quiet = TRUE)
```

```{r}
ht = c("primary", "secondary", "tertiary", "unclassified") # highway types of interest
osm_major_roads = osm_lines[osm_lines$highway %in% ht, ]
plot(osm_major_roads["highway"], key.pos = 1)
```

```{r}
mt = c("motorway") # highway types of interest
osm_mt = osm_lines[osm_lines$highway %in% mt, ]
plot(osm_mt["highway"], key.pos = 1)
```

```{r}
ldn_osm <- oe_match("Greater London")
```

```{r}
oe_download(
  file_url = ldn_osm$url, 
  file_size = ldn_osm$file_size,
  download_directory = "r5rdata/"
)
```

Not working after using R package for OSM pbf.. probably becasuse this package still uses geofabrik. 

In the end, the above factors are not the cause of the issue, but it is found that converting st data frame of point data to sf object give positive output. (see predic_access_time.RMD). 
