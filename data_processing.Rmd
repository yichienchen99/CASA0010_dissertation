---
title: "data_processing"
output: html_document
date: "2023-05-30"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This section clean and process OD data for the r5r input. The data from OSM is downloaded on 30 May 2023 from https://download.geofabrik.de/. 

r5r requires either a POINT sf object with WGS84 CRS, or a data.frame containing the columns id, lon and lat. So the projection will be set as EPSG4326..

## Load packages

```{r}
library(sf)
library(here)
library(tmap)
library(tmaptools)
library(stringr)
library(spatstat)
library(janitor)
library(dplyr)
library(tidyverse)
library(data.table)

```

## Read in


```{r}
London_borough <- st_read(here::here("data/London_Boroughs.gpkg"))%>%
    st_transform(., 4326)
```

```{r}
OSM_poi <- st_read(here::here("data/greater-london-latest-free.shp/gis_osm_pois_a_free_1.shp")) %>%
  st_transform(., 4326)
```
```{r}
OSM_poi2 <- st_read(here::here("data/greater-london-latest-free.shp/gis_osm_pois_free_1.shp")) %>%
  st_transform(., 4326)
```

```{r}
OSM_transport <- st_read(here::here("data/greater-london-latest-free.shp/gis_osm_transport_free_1.shp")) %>%
  st_transform(., 4326)
```
## FILTERING 

Then to reduce the data storage space and trim the OSM POI data, key amenities and public transport stations are kept. The selection of fclass in OSM is based on the data description: https://download.geofabrik.de/osm-data-in-gis-formats-free.pdf. 

```{r}
key_amenities <- c('school', 'hospital', 'pharmacy', 'supermarket')

OSM_poi <- OSM_poi %>%
  dplyr::filter(fclass %in% key_amenities)
```

This reduces POI data from 46325 features to 4252 features. 

```{r}
OSM_poi2 <- OSM_poi2 %>%
  dplyr::filter(fclass %in% key_amenities)
```

This reduces POI data from 80839 features to 1682 features. 
```{r}
PT_stations <- c('railway_station', 'bus_stop', 'bus_station', 'tram_stop')

OSM_transport <- OSM_transport %>%
  dplyr::filter(fclass %in% PT_stations)
```

This reduces 20958 transport data to 20730 features. 

## Simple mapping to check

```{r}
qtm(London_borough)
```

```{r}
tmap_mode("plot")
tm_shape(London_borough) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(OSM_transport) +
  tm_dots(col = "blue")
```

```{r}
tmap_mode("plot")
tm_shape(London_borough) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(OSM_poi) +
  tm_dots(col = "red")
```

```{r}
tmap_mode("plot")
tm_shape(London_borough) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(OSM_poi2) +
  tm_dots(col = "red")
```


## Combine POI 1 and 2 and check duplicates

since POI1 has geo type as multipolygon, it should be converted into point. 

```{r}
OSM_poi_p <- OSM_poi %>% 
  st_centroid()
```

```{r}
OSM_all <- rbind(OSM_poi_p, OSM_poi2) %>%
  distinct()
```

## combine POI and PT stations

```{r}
Dest_all <- rbind(OSM_all, OSM_transport) %>%
  distinct()
```

## Pivot longer to make fclass into separate columns with boolean 

```{r}
summary(Dest_all)
```

```{r}
Dest_wide <- Dest_all %>%
  mutate(school = case_when(fclass == 'school' ~ 1, fclass != 'school' ~ 0)) %>%
  mutate(hospital = case_when(fclass == 'hospital' ~ 1, fclass != 'hospital' ~ 0)) %>%
  mutate(pharmacy = case_when(fclass == 'pharmacy' ~ 1, fclass != 'pharmacy' ~ 0)) %>%
  mutate(supermarket = case_when(fclass == 'supermarket' ~ 1, fclass != 'supermarket' ~ 0)) %>%
  mutate(railway_station = case_when(fclass == 'railway_station' ~ 1, fclass != 'railway_station' ~ 0)) %>%
  mutate(bus_stop = case_when(fclass == 'bus_stop' ~ 1, fclass != 'bus_stop' ~ 0)) %>%
  mutate(bus_station = case_when(fclass == 'bus_station' ~ 1, fclass != 'bus_station' ~ 0)) %>%
  mutate(tram_stop = case_when(fclass == 'tram_stop' ~ 1, fclass != 'tram_stop' ~ 0))
```

```{r}
Dest_wide <- Dest_wide %>%
  mutate(amenities = case_when(fclass %in% key_amenities ~ 1, fclass %in% PT_stations ~ 0)) %>%
  mutate(stations = case_when(fclass %in% PT_stations ~ 1, fclass %in% key_amenities ~ 0))
```

## data cleaning

Delete points outside london boroughs and columns that will not be used. 
Change column name of osm_id to id as required by r5r.
Spatial join to assign borough info to points.
Keep only the columns that could be useful. 

```{r}
Dest_wide_subset <- Dest_wide[London_borough,] %>% 
  rename("id" = "osm_id")%>%
  st_join(London_borough)%>%
  select(id, geometry, school, hospital, pharmacy, supermarket, railway_station, bus_stop, bus_station, tram_stop,amenities, stations, gss_code, ons_inner, sub_2011)
```

## lat and lon

Since the geometry of the points are not in the format required by r5r, the geometry column needs to be transformed.

```{r}
Dest_wide_latlon <- Dest_wide_subset %>% 
  extract(geometry, c('lat', 'lon'), '\\((.*), (.*)\\)', convert = TRUE) 
```


## map all destination points

```{r}
tmap_mode("plot")
tm_shape(London_borough) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(Dest_wide_subset) +
  tm_dots(col = "red")
```


## For origin points
## Read in data

```{r}
PTAL_grid <- read.csv(here::here("data/PTAL_grid_2015/2015_PTALs_Grid_Values_280515.csv"), 
                         header = TRUE, sep = ",",  
                         encoding = "latin1")
```

```{r}
summary(PTAL_grid)
```

## organise the data type and format

The original lon and lat variables seem like in EPSG 27700 (british national grid), to convert this into WGS84 / EPSG 4326, we first convert the float values to geometry points. Then we can reproject the data into ideal projection. When necessary, we can also convert the geometry points to two separate columns of lon and lat. 

```{r}
tosf <- PTAL_grid%>%
  st_as_sf(., coords = c("X", "Y"), 
                   crs = 27700)
```

```{r}
to84 <- tosf %>%
    st_transform(., 4326)
```


## Map 

To check if the conversion is correct, map the points. 

```{r}
tmap_mode("plot")
tm_shape(London_borough) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(to84) +
  tm_dots(col = "red")
```

Seems good, it can also be zoomed in to further check. To zoom in, we can first assign each points with their borough name through spatial join. 

```{r}
PTAL_grid_boroughname <- to84 %>%
  st_join(London_borough)
```


```{r}
PTAL_grid_camden <- PTAL_grid_boroughname %>%
  filter(gss_code == 'E09000007')
```

```{r}
tmap_mode("plot")
tm_shape(PTAL_grid_camden) +
  tm_dots(col = "red") +
tm_shape(London_borough) +
  tm_polygons(col = NA, alpha = 0.5)
```

Looks good too! Then we can plot a gradient map using the points and PTAL values. 

```{r}
tmap_mode("plot")
tm_shape(PTAL_grid_boroughname) +
  tm_dots(col = "AI2015",
          palette="PuBu")  +
tm_shape(London_borough) +
  tm_borders(col = "black", alpha = 0.5)
```
The above shows the Access Index values, before converted into the PTAL bands. Extremely high values tend to concentrate in inner London... Below shows the result comparing to PTAL band that is commonly used to inform the decision making in planning. 

```{r}
tmap_mode("plot")
tm_shape(PTAL_grid_boroughname) +
  tm_dots(col = "PTAL2015",
          palette="PuBu") +
tm_shape(London_borough) +
  tm_borders(col = "black", alpha = 0.5)
```

The output looks quite like the current PTAL map on WEBCAT: https://tfl.gov.uk/info-for/urban-planning-and-construction/planning-with-webcat/webcat. 

However, the inner and outer London's difference in access levels is not represented completely in the second map, but in the first map showing sharp contrast. This may mislead the interpretation of local connectivity in Outer London. The connectivity there can be better in some locations with tube stations, but in other parts, people may take longer to get to the transit. Housing development in those areas may still lead to high car dependency due to limited connectivity. 

PTAL is related to time reliability of transport services, distance between OD pairs, number and frequency of transport services.

## delete unnecessary info & lat and lon

Delete points outside london boroughs and columns that will not be used. 
Since the geometry of the points are not in the format required by r5r, the geometry column needs to be transformed.

```{r}
PTAL_grid_latlon <- PTAL_grid_boroughname %>%
  rename("id" = "ID")%>%
  select(id, AI2015, PTAL2015, name, gss_code, ons_inner, sub_2011, geometry) %>%
  extract(geometry, c('lat', 'lon'), '\\((.*), (.*)\\)', convert = TRUE) 
```

## Conclusion

This section process the OD pairs. All point data is now in WSG84, with id, lat, lon fields. 

- PTAL_grid_latlon: PTAL centroids as of 2015
- Dest_wide_latlon: all destination points of interest within London, type of destination in boolean. 

Then those files can be saved in data directory as csv. 

```{r}

fwrite(PTAL_grid_latlon, "data\\origin.csv")
fwrite(Dest_wide_latlon, "data\\destination.csv")

```
